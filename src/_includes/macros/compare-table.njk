{# _includes/compare-table.njk #}
{% macro compareTable(items) %}
  <table class="compare-table">
    <thead>
      <tr>
        <th>Spec</th>
        {% for item in items %}
          <th>{{ item.name }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {# Iterate the groups and fields directly from the first item to avoid precedence bugs #}
      {% for group in items[0].groupedSpecs %}
        {% set groupIndex = loop.index0 %}
        <tr class="group-header">
          <td colspan="{{ items | length + 1 }}"><strong>{{ group.name }}</strong></td>
        </tr>

        {% for field in group.fields %}
          {% set fieldIndex = loop.index0 %}
          <tr>
            <td>{{ field.label }}</td>
            {% for item in items %}
              {# Safely access the same group/field index for each item; fall back to null if missing #}
              {% set groupForItem = item.groupedSpecs[groupIndex] if item.groupedSpecs and item.groupedSpecs[groupIndex] is defined else null %}
              {% set fieldForItem = groupForItem and groupForItem.fields[fieldIndex] is defined and groupForItem.fields[fieldIndex] or null %}
              <td>
                {% if fieldForItem and fieldForItem.value is iterable and fieldForItem.value is not string %}
                  {{ fieldForItem.value | join(", ") }}
                {% else %}
                  {{ fieldForItem and fieldForItem.value or "" }}
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}
